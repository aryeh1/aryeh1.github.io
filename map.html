<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geoapify Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; color: #1e293b; padding-bottom: 150px; }
        .btn-control { @apply h-14 bg-white border border-slate-200 rounded-2xl shadow-sm active:bg-slate-50 active:scale-95 transition-all flex items-center justify-center text-slate-600 text-xl; }
        .input-std { @apply h-12 bg-white border border-slate-200 rounded-xl px-4 text-base w-full focus:ring-2 focus:ring-blue-500 outline-none transition-shadow; }
        .label-std { @apply block text-xs font-bold text-slate-500 mb-2; }
        
        .sticky-map { 
            position: sticky; top: 0; z-index: 50; 
            background: #f1f5f9; padding-bottom: 12px; 
            border-bottom: 1px solid #e2e8f0; 
            transition: all 0.2s ease-out;
        }
        body.keyboard-open .sticky-map { position: static; border-bottom: none; padding-bottom: 0; margin-bottom: 20px; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="max-w-lg mx-auto min-h-screen">

    <!-- מפה דביקה -->
    <div class="sticky-map px-4 pt-4 shadow-sm backdrop-blur-sm bg-slate-100/95" id="mapContainer">
        <div class="relative bg-slate-200 rounded-2xl overflow-hidden border-2 border-white shadow-lg aspect-[3/2] mb-3">
            <img id="mapImage" src="" class="w-full h-full object-contain bg-slate-100" alt="Map Preview">
            <div id="loader" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600"></i>
            </div>
            <div id="errorMsg" class="absolute inset-0 bg-red-50 flex flex-col items-center justify-center hidden text-red-600 p-6 text-center">
                <i class="fa-solid fa-triangle-exclamation text-3xl mb-3"></i>
                <span class="font-bold block mb-1">שגיאה בטעינה</span>
                <span class="text-xs opacity-75">נא לטעון לינק תקין הכולל API Key</span>
            </div>
        </div>

        <div class="flex gap-3 mb-1">
             <div class="relative flex-1">
                 <input type="text" id="finalUrl" readonly class="w-full h-12 pl-2 pr-10 bg-white border border-slate-300 rounded-xl text-xs font-mono text-slate-500 focus:outline-none" value="...">
                 <div class="absolute top-0 left-0 h-full w-10 flex items-center justify-center text-slate-400">
                     <i class="fa-solid fa-link"></i>
                 </div>
             </div>
             <button onclick="copyUrl()" class="h-12 bg-blue-600 text-white px-6 rounded-xl font-bold text-sm shadow-md active:bg-blue-700 whitespace-nowrap">
                 העתק
             </button>
        </div>
    </div>

    <!-- אזור שליטה -->
    <div class="px-5 space-y-8 mt-6">

        <!-- טעינת לינק -->
        <div class="bg-indigo-50 p-6 rounded-3xl shadow-sm border border-indigo-100">
            <h3 class="font-bold text-indigo-900 text-lg mb-4 flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-down text-indigo-500"></i>
                טען לינק לעריכה
            </h3>
            <div class="flex gap-2">
                <input type="text" id="importUrlInput" class="input-std text-xs font-mono" placeholder="הדבק כאן לינק מלא...">
                <button onclick="importLink()" class="h-12 bg-indigo-600 text-white px-5 rounded-xl font-bold shadow-md active:bg-indigo-700">
                    טען
                </button>
            </div>
        </div>

        <!-- ניווט -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-sm"><i class="fa-regular fa-compass"></i></span>
                    מיקום
                </h3>
                <span id="centerDisplay" class="text-xs font-mono bg-slate-100 px-3 py-1 rounded-full text-slate-500">Lat/Lon</span>
            </div>

            <div class="flex gap-6">
                <div class="grid grid-cols-3 gap-2 w-36 shrink-0">
                    <div class="col-start-2"><button onclick="nudge(0, 0.005)" class="btn-control"><i class="fa-solid fa-chevron-up"></i></button></div>
                    <div class="col-start-1 row-start-2"><button onclick="nudge(-0.01, 0)" class="btn-control"><i class="fa-solid fa-chevron-left"></i></button></div>
                    <div class="col-start-2 row-start-2 flex items-center justify-center"><div class="w-3 h-3 bg-slate-200 rounded-full"></div></div>
                    <div class="col-start-3 row-start-2"><button onclick="nudge(0.01, 0)" class="btn-control"><i class="fa-solid fa-chevron-right"></i></button></div>
                    <div class="col-start-2 row-start-3"><button onclick="nudge(0, -0.005)" class="btn-control"><i class="fa-solid fa-chevron-down"></i></button></div>
                </div>

                <div class="flex-1 flex flex-col justify-center gap-3">
                    <label class="text-center text-xs font-bold text-slate-400">זום</label>
                    <div class="flex items-center gap-3">
                        <button onclick="adjZoom(-0.2)" class="btn-control w-14 text-2xl font-bold bg-slate-50">-</button>
                        <div class="flex-1 text-center font-mono text-xl font-bold text-blue-600" id="zoomVal"></div>
                        <button onclick="adjZoom(0.2)" class="btn-control w-14 text-2xl font-bold bg-slate-50">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- סיכות -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <span class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center text-sm"><i class="fa-solid fa-location-dot"></i></span>
                    סיכות (<span id="markerCount">0</span>)
                </h3>
                <button onclick="addMarker()" class="bg-blue-50 text-blue-600 px-5 py-2.5 rounded-xl text-sm font-bold border border-blue-100 active:bg-blue-100">
                    + חדש
                </button>
            </div>
            <div id="markersList" class="space-y-6"></div>
        </div>

        <!-- הגדרות -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-800 text-lg mb-5 flex items-center gap-2">
                <i class="fa-solid fa-sliders text-slate-400"></i> הגדרות
            </h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="label-std">רוחב</label><input type="number" id="width" class="input-std text-center"></div>
                <div><label class="label-std">גובה</label><input type="number" id="height" class="input-std text-center"></div>
            </div>
            <div class="mb-4">
                <label class="label-std">סגנון</label>
                <select id="style" class="input-std bg-no-repeat bg-[left_1rem_center]">
                    <option value="osm-liberty">OSM Liberty</option>
                    <option value="osm-bright">OSM Bright</option>
                    <option value="osm-carto">OSM Carto</option>
                    <option value="dark-matter">Dark Matter</option>
                </select>
            </div>
            <!-- שדה מפתח מוסתר אך קיים לוגית -->
            <div class="hidden">
                 <input type="text" id="apiKey" class="input-std">
            </div>
        </div>
        <div class="h-10"></div>
    </div>

    <!-- תבנית סיכה -->
    <template id="markerTemplate">
        <div class="marker-card bg-slate-50 border border-slate-200 rounded-2xl p-5 relative group transition-all hover:border-blue-300 shadow-sm">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="relative overflow-hidden w-12 h-12 rounded-full border-2 border-white shadow-sm ring-1 ring-slate-100">
                        <input type="color" class="m-color absolute -top-4 -left-4 w-20 h-20 cursor-pointer">
                    </div>
                </div>
                <button class="remove-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-red-500 bg-white hover:bg-red-50 rounded-xl border border-slate-200 transition-colors">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
            <div class="mb-4 relative">
                <div class="flex gap-2">
                    <input type="text" class="m-search input-std h-12 text-sm pl-2 pr-2" placeholder="חפש כתובת...">
                    <button class="m-search-btn bg-blue-600 text-white w-14 rounded-xl flex items-center justify-center shadow-sm text-lg">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
                <div class="m-search-msg text-xs mt-2 font-medium px-1 truncate min-h-[20px]"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">Lat</label><input type="number" step="0.000001" class="m-lat bg-white border border-slate-200 rounded-lg px-2 h-10 w-full text-xs font-mono"></div>
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">Lon</label><input type="number" step="0.000001" class="m-lon bg-white border border-slate-200 rounded-lg px-2 h-10 w-full text-xs font-mono"></div>
            </div>
            <button class="center-on-marker-btn w-full py-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-bold rounded-xl transition-colors flex items-center justify-center gap-2 shadow-sm">
                <i class="fa-solid fa-crosshairs text-blue-500"></i> עבור למיקום זה
            </button>
        </div>
    </template>

    <script>
        // מצב התחלתי ריק ממפתחות
        let state = {
            center: { lat: 51.5626, lon: -0.1652 },
            zoom: 10.4,
            width: 600,
            height: 400,
            style: 'osm-liberty',
            markers: [
                { lat: 51.513363, lon: -0.087459, color: '#0000ff' },
                { lat: 51.5897175, lon: -0.2216026, color: '#ff00ff' },
                { lat: 51.5890823, lon: -0.166091, color: '#ff00ff' },
                { lat: 51.5384287, lon: -0.0999051, color: '#00ffff' },
                { lat: 51.5048954, lon: -0.0190006, color: '#00ffff' },
                { lat: 51.5500554, lon: -0.1425712, color: '#00ffff' },
                { lat: 51.5509898, lon: -0.1917279, color: '#ff00ff' },
                { lat: 51.5473926, lon: -0.1683005, color: '#00ffff' },
                { lat: 51.5266694, lon: -0.0798926, color: '#00ffff' },
                { lat: 51.6176443, lon: -0.276739, color: '#ff00ff' },
                { lat: 51.541882, lon: -0.1979358, color: '#000000' }
            ],
            apiKey: '' // הוסר לבקשתך
        };

        const els = {
            map: document.getElementById('mapImage'),
            loader: document.getElementById('loader'),
            error: document.getElementById('errorMsg'),
            url: document.getElementById('finalUrl'),
            centerDisplay: document.getElementById('centerDisplay'),
            zoomVal: document.getElementById('zoomVal'),
            list: document.getElementById('markersList'),
            count: document.getElementById('markerCount'),
            inputs: {
                w: document.getElementById('width'),
                h: document.getElementById('height'),
                s: document.getElementById('style'),
                k: document.getElementById('apiKey')
            }
        };

        let debounceTimer;

        // --- מנגנון יבוא לינק ---
        function importLink() {
            const val = document.getElementById('importUrlInput').value.trim();
            if(!val) return;
            
            try {
                const urlObj = new URL(val);
                const p = urlObj.searchParams;

                if(p.has('width')) state.width = p.get('width');
                if(p.has('height')) state.height = p.get('height');
                if(p.has('zoom')) state.zoom = parseFloat(p.get('zoom'));
                if(p.has('style')) state.style = p.get('style');
                
                // שליפת המפתח מהלינק
                if(p.has('apiKey')) state.apiKey = p.get('apiKey');

                const c = p.get('center');
                if(c && c.startsWith('lonlat:')) {
                    const [lon, lat] = c.replace('lonlat:', '').split(',');
                    state.center = { lat: parseFloat(lat), lon: parseFloat(lon) };
                }

                const markersRaw = p.getAll('marker');
                const newMarkers = [];
                markersRaw.forEach(mStr => {
                    const parts = mStr.split(';');
                    let mObj = { lat: 0, lon: 0, color: '#ff0000' };
                    parts.forEach(part => {
                        if(part.startsWith('lonlat:')) {
                            const [lon, lat] = part.replace('lonlat:', '').split(',');
                            mObj.lon = parseFloat(lon);
                            mObj.lat = parseFloat(lat);
                        }
                        if(part.startsWith('color:')) {
                            mObj.color = decodeURIComponent(part.replace('color:', ''));
                        }
                    });
                    newMarkers.push(mObj);
                });

                if(newMarkers.length > 0) state.markers = newMarkers;

                syncUI();
                render();

            } catch(e) {
                alert('לינק לא תקין');
            }
        }

        function syncUI() {
            els.inputs.w.value = state.width;
            els.inputs.h.value = state.height;
            els.inputs.s.value = state.style;
            els.inputs.k.value = state.apiKey;
            
            els.list.innerHTML = '';
            state.markers.forEach(m => createMarkerUI(m));
        }

        document.addEventListener('focus', (e) => { if (e.target.tagName === 'INPUT') document.body.classList.add('keyboard-open'); }, true);
        document.addEventListener('blur', (e) => { if (e.target.tagName === 'INPUT') setTimeout(() => { if (document.activeElement.tagName !== 'INPUT') document.body.classList.remove('keyboard-open'); }, 100); }, true);

        function buildUrl() {
            // אם אין מפתח, לא מייצרים URL תקין עדיין
            if (!state.apiKey) return "";

            let url = `https://maps.geoapify.com/v1/staticmap?`;
            url += `style=${els.inputs.s.value}&width=${els.inputs.w.value}&height=${els.inputs.h.value}`;
            url += `&center=lonlat:${state.center.lon},${state.center.lat}&zoom=${state.zoom}&scaleFactor=2`;

            const cards = document.querySelectorAll('.marker-card');
            state.markers = [];
            cards.forEach(card => {
                const lat = card.querySelector('.m-lat').value;
                const lon = card.querySelector('.m-lon').value;
                const color = encodeURIComponent(card.querySelector('.m-color').value);
                
                if(lat && lon) {
                    let m = `&marker=lonlat:${lon},${lat};color:${color};size:medium`;
                    url += m;
                    state.markers.push({ lat, lon, color: decodeURIComponent(color) });
                }
            });

            url += `&apiKey=${state.apiKey}`;
            return url;
        }

        function render() {
            els.zoomVal.innerText = state.zoom.toFixed(1);
            els.centerDisplay.innerText = `${state.center.lat.toFixed(4)}, ${state.center.lon.toFixed(4)}`;
            els.count.innerText = document.querySelectorAll('.marker-card').length;
            
            const url = buildUrl();
            
            if (!url) {
                els.error.classList.remove('hidden'); // הצגת שגיאה אם אין מפתח
                return;
            }

            els.url.value = url;
            els.loader.classList.remove('hidden');
            els.error.classList.add('hidden');

            const img = new Image();
            img.onload = () => { els.map.src = url; els.loader.classList.add('hidden'); };
            img.onerror = () => { els.loader.classList.add('hidden'); els.error.classList.remove('hidden'); };
            img.src = url;
        }

        function requestUpdate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(render, 600);
        }

        async function geocodeAddress(query, cardEl) {
            if (!state.apiKey) { alert('חסר API Key. נא לטעון לינק תחילה.'); return; }
            
            const msgEl = cardEl.querySelector('.m-search-msg');
            const latEl = cardEl.querySelector('.m-lat');
            const lonEl = cardEl.querySelector('.m-lon');
            const btn = cardEl.querySelector('.m-search-btn');

            if(!query) return;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            msgEl.textContent = 'מחפש...';
            msgEl.className = 'm-search-msg text-xs mt-2 font-medium px-1 truncate text-blue-500';

            try {
                const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(query)}&apiKey=${state.apiKey}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.features && data.features.length > 0) {
                    const coords = data.features[0].geometry.coordinates;
                    lonEl.value = coords[0];
                    latEl.value = coords[1];
                    msgEl.textContent = `נמצא: ${data.features[0].properties.formatted}`;
                    msgEl.className = 'm-search-msg text-xs mt-2 font-medium px-1 truncate text-green-600';
                    requestUpdate();
                } else {
                    msgEl.textContent = 'לא נמצא';
                    msgEl.className = 'm-search-msg text-xs mt-2 font-medium px-1 truncate text-red-500';
                }
            } catch (err) {
                msgEl.textContent = 'שגיאה';
            } finally {
                btn.innerHTML = originalIcon;
            }
        }

        function createMarkerUI(data) {
            const tmpl = document.getElementById('markerTemplate').content.cloneNode(true);
            const div = document.createElement('div');
            div.appendChild(tmpl);
            
            const card = div.querySelector('.marker-card');
            const latIn = card.querySelector('.m-lat');
            const lonIn = card.querySelector('.m-lon');
            const colIn = card.querySelector('.m-color');
            const searchIn = card.querySelector('.m-search');
            const searchBtn = card.querySelector('.m-search-btn');
            const centerBtn = card.querySelector('.center-on-marker-btn');

            latIn.value = data.lat;
            lonIn.value = data.lon;
            colIn.value = data.color;

            card.querySelector('.remove-btn').onclick = () => { card.remove(); requestUpdate(); };
            searchBtn.onclick = () => geocodeAddress(searchIn.value, card);
            searchIn.onkeypress = (e) => { if(e.key === 'Enter') geocodeAddress(searchIn.value, card); };
            centerBtn.onclick = () => {
                const lat = parseFloat(latIn.value);
                const lon = parseFloat(lonIn.value);
                if(lat && lon) {
                    state.center.lat = lat;
                    state.center.lon = lon;
                    render();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            [latIn, lonIn, colIn].forEach(el => el.addEventListener('input', requestUpdate));
            els.list.appendChild(div);
        }

        window.addMarker = () => {
            createMarkerUI({ lat: state.center.lat, lon: state.center.lon, color: '#ff0000' });
            requestUpdate();
        };

        window.nudge = (lonD, latD) => {
            state.center.lat = parseFloat((state.center.lat + latD).toFixed(6));
            state.center.lon = parseFloat((state.center.lon + lonD).toFixed(6));
            render();
        };

        window.adjZoom = (diff) => {
            let z = parseFloat(state.zoom) + diff;
            if(z < 1) z = 1; if(z > 20) z = 20;
            state.zoom = parseFloat(z.toFixed(1));
            render();
        };

        window.copyUrl = () => {
            els.url.select();
            document.execCommand('copy');
            const btn = document.querySelector('button[onclick="copyUrl()"]');
            const t = btn.innerText; btn.innerText = 'הועתק!'; setTimeout(() => btn.innerText = t, 2000);
        };
        
        syncUI();
        Object.values(els.inputs).forEach(el => el.addEventListener('input', requestUpdate));
        // לא מרנדר מיד כי אין מפתח
        render();

    </script>
</body>
</html>
